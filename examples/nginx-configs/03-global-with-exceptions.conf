# Global Enablement with Path Exceptions
# Use this template when you want conversion enabled by default with specific exclusions

# Load the markdown filter module (for dynamic module builds)
load_module modules/ngx_http_markdown_filter_module.so;

events {
    worker_connections 2048;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;

    # Enable Markdown conversion globally
    markdown_filter on;
    markdown_max_size 10m;
    markdown_timeout 5s;
    markdown_on_error pass;  # Fail-open for availability

    # Optional: detect Markdown requests for conditional upstream compression
    map $http_accept $markdown_requested {
        default 0;
        "~*(^|,)\\s*text/markdown(\\s*;|,|$)" 1;
    }

    map $markdown_requested $upstream_accept_encoding {
        0 $http_accept_encoding;
        1 "";  # Disable upstream compression for Markdown requests
    }

    server {
        listen 80;
        server_name example.com;  # CHANGE THIS

        # Main content: conversion enabled (inherited from http block)
        location / {
            proxy_set_header Accept-Encoding $upstream_accept_encoding;
            proxy_pass http://backend;  # CHANGE THIS
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # API endpoints: disable conversion
        location ^~ /api/ {
            markdown_filter off;
            proxy_pass http://backend;  # CHANGE THIS
            proxy_set_header Host $host;
        }

        # Static assets: disable conversion
        location ^~ /assets/ {
            markdown_filter off;
            proxy_pass http://backend;  # CHANGE THIS
        }

        # Downloads: disable conversion
        location ^~ /downloads/ {
            markdown_filter off;
            proxy_pass http://backend;  # CHANGE THIS
        }

        # Native Markdown files: already suitable for agents
        location ~* \.md$ {
            markdown_filter off;
            proxy_pass http://backend;  # CHANGE THIS
        }

        # Metrics endpoint (localhost only)
        location /markdown-metrics {
            markdown_metrics;
            allow 127.0.0.1;
            allow ::1;
            deny all;
        }
    }
}
